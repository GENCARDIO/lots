<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
   {% include 'Header/header.html' %}
<script>
    var list_info_lots;

    /**
     * Canvia totes les barras ("/") en el valor d'entrada per guions ("-").
     * @param {object} input L'element d'entrada que conte el valor a modificarr.
     * @returns {void} No retorna cap valor.
     */
    function replae_slash_with_hyphen(input) {
        input.value = input.value.replace(/\//g, '-');
    }


    /**
     * Si l'usuari ppsa algun caràcter no permes l'elimina.
     * @param {object} input L'element d'entrada que conte el valor a modificarr.
     * @returns {void} No retorna cap valor.
     */
    function filter_characters(input) {
        // Filtrar caracteres permitidos usando una expresión regular
        input.value = input.value.replace(/[^-0-9NA-na-]/g, '');
    }

  
    /**
     * Neteja els camps d'entrada y mostra el modal de add_lote.
     * @param {string} acronim És l'acronim de l'usuari.
     * @returns {void} No retorna cap valor.
     */
    function insert(acronim){
        // document.getElementById('type_lot').value = ''
        // document.getElementById('lot_name').value = ''
        // document.getElementById('reference').value = ''
        // document.getElementById('trademark').value = ''
        // document.getElementById('preserved_in').value = ''
        // document.getElementById('stock_minimum').value = ''
        // document.getElementById('date_arrived').value = ''
        // document.getElementById('supplier_lot').value = ''
        // document.getElementById('expiry').value = ''
        // document.getElementById('internal_lot').value = ''
        // document.getElementById('tecnic').value = acronim
        // document.getElementById('data_open').value = ''
        // document.getElementById('tecnic_open').value = ''
        // document.getElementById('data_close').value = ''
        // document.getElementById('tecnic_close').value = ''
        // document.getElementById('observations').value = ''
        document.getElementById('code_search').value = ''
        document.getElementById('code_panel').value = ''
        document.getElementById('div_panel').style.display = 'none'
        $('#add_lot').modal('show');
    }


    /**
     * La funció mira si el codi que hem entrat ja el tenim a la base de dades, si no el tenim s'ha d'afegir 
     * un lot nou i en cas que el tinguem afegirem stock a la BD. Cada acció obrirà un modal diferent.
     * 
     * @param {string} acronim L'acrònim utilitzat per configurar alguns camps.
     * @param {string} code_search Codi que farem servir per buscar a la BD.
     * @returns {void} No retorna cap valor.
     * 
     * @descriptor Aquesta funció executa diverses accions, com ara l'enviament de dades a través d'una 
     * sol·licitud AJAX, la configuració de camps de formulari i la manipulació de l'estructura HTML per mostrar
     * la informació del lot afegit. Quan ens retornen la informació amb xhr.responseText agafem la resposta i la
     * tractarem per veure com ha anat, depèn de la resposta que obtinguem farem les accions pertinents.
     * També es fan comprobacions de que el que ens ha entrat per paràmetre sigui correcta.
     * 
     */
    function info_add_lot(acronim, rol){
        document.getElementById('unit_lots').value = 1;
        // Crear form data
        var form_data = new FormData();
        
        // Carregar dades al form de l'html
        const code_search = document.getElementById('code_search').value
        const code_panel = document.getElementById('code_panel').value

        var regex = /^\s*$/;
        var only_space = regex.test(code_search);
        if (only_space){alert("El camp no pot estar buït"); return}
        if (code_search.length < 3){alert("El codi no to tenir menys de 3 caràcters."); return }
                    
        form_data.append('code_search', code_search)
        form_data.append('code_panel', code_panel)

        $('#add_lot').modal('hide');

        // Creeem l'objecte per l'ajax
        var xhr = new XMLHttpRequest();
        // 1er argument si es pots o get
        // 2n argument url o ruta
        // 3r argumemt true sempre
        xhr.open('POST', '/search_add_lot', true);
        xhr.onload = function(){
            if (xhr.status === 200) {
                var response = xhr.responseText;

                var split_response = response.split('_//_')

                if (split_response[0] === 'True'){
                    message = ''
                    if (split_response[1] === 'new'){
                        if (rol === 'admin'){
                            show_reactive('')
                            document.getElementById("code_log").value = '';
                            document.getElementById("code_sap").value = '';
                            document.getElementById("manufacturer").value = '';
                            document.getElementById("analytical_technique").value = '';
                            document.getElementById("description").value = '';
                            document.getElementById('num_lots').value = 0;            
                            document.getElementById('reference_catalog').value = code_search;      
                            document.getElementById("supplier").value = '';

                            // Eliminar tots els divs amb el name divs_new_lots
                            var elementosAEliminar = document.querySelectorAll('div[name="divs_new_lots"]');
                                elementosAEliminar.forEach(function(elemento) {
                                    elemento.remove(); });

                            var miDiv = document.getElementById('div_info_new_lot');
                            var nuevoHTML = `
                                <div class="col-lg-6 col-md-6 col-sm-12 divs_reatives" name="divs_new_lots">       
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Temp. conservació :</b></span>
                                        <select class="form-select" id="temp_conservation0">
                                            <option>-20</option>
                                            <option>-80</option>
                                            <option>Ambient</option>
                                            <option>4</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Reactiu o fungible :</b></span>
                                        <select class="form-select" id="react_or_fungible0" onchange="show_reactive(this.value)">
                                            <option>Reactiu</option>
                                            <option>Fungible</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-12 divs_reatives" name="divs_new_lots">       
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Id panell(*) :</b></span>
                                        <input type="text" class="form-control" aria-label="TTN" id="code_panel0" value='${code_panel}'>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_new_lots">       
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Ubicació :</b></span>
                                        <select class="form-select" id="location0">
                                            <option selected></option>
                                            <option>Lab1-Extracció</option>
                                            <option>Lab2-AP</option>
                                            <option>Lab3-Màquines</option>
                                            <option>Lab4-PCR</option>
                                            <option>Lab5-PrePCR</option>
                                            <option>Lab Cuina</option>
                                            <option>Magatzem</option>
                                            <option>Magatzem Fred</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_new_lots">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Format compra :</b></span>
                                        <select class="form-select" id="purchase_format0">
                                            <option selected>kit</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_new_lots">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Unitats format :</b></span>
                                        <select class="form-select" id="units_format0">
                                            <option selected>1</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Import u. ICS :</b></span>
                                        <input type="number" class="form-control" aria-label="TTN" id="import_unit_ics0">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Import u. IDIBGI :</b></span>
                                        <input type="number" class="form-control" aria-label="TTN" id="import_unit_idibgi0">
                                    </div>
                                </div>
                                `;
                            // Agrega el nuevo conjunto debajo del div existente
                            miDiv.insertAdjacentHTML('afterend', nuevoHTML);
                            $('#add_new_lot').modal('show'); }
                        else { 
                            message = `L'article ${code_search} no està registrat, contacta amb un administrador perquè registri el producte.`
                            alert_type = 'warning'}
                    }
                    else {
                        // obtenir i formatar la data
                        var current_date = new Date();
                        var day = current_date.getDate();
                        var month = current_date.getMonth() + 1;
                        var year = current_date.getFullYear();
                        day = day < 10 ? '0' + day : day;
                        month = month < 10 ? '0' + month : month;
                        var formated_date = day + '-' + month + '-' + year;
                        var internal_lot = year + month + day

                        show_div_product('product_reception', 'qc_reception', 'btn_1', 'btn_2')
                        document.getElementById('transport_conditions').value = ''
                        document.getElementById('inspected_by').value = acronim
                        document.getElementById('packaging').value = ''
                        document.getElementById('date_inspected').value = formated_date
                        document.getElementById('observations_inspection').value = ''
                        document.getElementById('state').value = 'Acceptat'
                        document.getElementById('comand_number').value = ''
                        document.getElementById('file_delivery_note').value = ''
                        document.getElementById('file_certificate').value = ''
                        document.getElementById('revised_by').value = acronim
                        document.getElementById('date_revised').value = formated_date
                        document.getElementById('cost_center_stock').value = ''

                        // Eliminar tots els div amb el name divs_subproduct
                        var elementosAEliminar = document.querySelectorAll('div[name="divs_subproducts"], input[name="divs_subproducts"]');
                        elementosAEliminar.forEach(function(elemento) {
                            elemento.remove(); });

                        document.getElementById('date_recepcion_lot').value = formated_date;
                        
                        var miDiv = document.getElementById('div_info_lot');
                        list_info_lots = JSON.parse(split_response[1]);
                        list_commands = JSON.parse(split_response[2]);

                        document.getElementsByName("title_add_lots")[0].textContent = `Afegeix article : ${list_info_lots[0]['catalog_reference']}`;

                        document.getElementById("description_add_lot").value = `${list_info_lots[0]['description']}`;
                        
                        document.getElementById("info_command").style.display = 'none';

                        var select = document.getElementById('select_substract_lot');
                        // Limpiamos todas las opciones existentes del <select>
                        select.innerHTML = '';
                        document.getElementById('div_substract_lot').style.display = 'none';
                        document.getElementById('div_substract_lot_hr').style.display = 'none';

                        if (list_info_lots[0]['command_pending'] != ''){
                            document.getElementById("info_command").style.display = 'block';
                            document.getElementById("text_info_command").innerHTML = "<b><i>" + list_info_lots[0]['command_pending'] + "</i></b>";
                            document.getElementById('id_command').value = list_info_lots[0]['id_command']
                            document.getElementById('user_add_command').value = list_info_lots[0]['user_add_command']
                            document.getElementById('cost_center_stock').value = list_info_lots[0]['ceco_command']

                            if(list_commands.length > 1){
                                document.getElementById('div_substract_lot').style.display = 'block';
                                document.getElementById('div_substract_lot_hr').style.display = 'block';

                                list_commands.forEach(function(row) {
                                    // Creamos un nuevo elemento <option>
                                    var option = document.createElement('option');
                                    
                                    // Establecemos el valor y el texto del elemento <option>
                                    option.value = row[0];  // El primer valor de la fila como valor de la opción
                                    option.textContent = row[1] + ' - ' + row[2] + ' - ' + row[3];  // Combinación del segundo y tercer valor de la fila como texto de la opción
                                    
                                    // Añadimos la opción al <select>
                                    select.appendChild(option);
                                });
                            }
                        }

                        var HTML = `
                            <div class="col-lg-5 col-md-12 col-sm-12" name="divs_subproducts">
                                <hr>
                            </div>
                            <div class="col-lg-2 col-md-12 col-sm-12" name="divs_subproducts">
                                <center>Article 1</center>
                            </div>
                            <div class="col-lg-5 col-md-12 col-sm-12" name="divs_subproducts">
                                <hr>
                            </div>
                        `;

                        // Agrega el nuevo conjunto debajo del div existente
                        miDiv.insertAdjacentHTML('beforebegin', HTML);

                        for (var i = 0; i < list_info_lots.length; i++) {
                            var dict_lots = JSON.stringify(list_info_lots[i]);
                            if (list_info_lots[i]['temp_conservation'] == '4'){
                                temperature = `+${list_info_lots[i]['temp_conservation']} °C`}
                            else if (list_info_lots[i]['temp_conservation'] == '-20'){
                                temperature = `${list_info_lots[i]['temp_conservation']} °C`}
                            else if (list_info_lots[i]['temp_conservation'] == '-80'){
                                temperature = `${list_info_lots[i]['temp_conservation']} °C`}
                            else{
                                temperature = `${list_info_lots[i]['temp_conservation']}`}
                            var nuevoHTML_variable = `<div class="col-lg-12 col-md-12 col-sm-12" name="divs_subproducts" style="display: none;">`
                            var nuevoHTML_variable2 = `<div class="col-lg-12 col-md-12 col-sm-12" name="divs_subproducts">`
                            var nuevoHTML_context = `
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Descripció :</b></span>
                                        <input type="text" class="form-control" id="descripton0_${i}" aria-label="TTN" value="${list_info_lots[i]['id_reactive']} || ${list_info_lots[i]['description_subreference']}" readonly>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Lot :</b></span>
                                        <input type="text" class="form-control" id="lot0_${i}" aria-label="TTN" value="">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">  
                                    <div class='input-group mb-3'>
                                        <span class='input-group-text' id='basic-addon1' style='width: 148px;'><b>Data caducitat :</b></span>
                                        <input type="text" class="form-control" id="expiry_date0_${i}" aria-label="TTN" aria-describedby="basic-addon1" oninput="replae_slash_with_hyphen(this); filter_characters(this)" value="">
                                    </div>
                                </div>
                                `;
                            if (list_info_lots[i]['react_or_fungible'] == 'Fungible'){
                                var nuevoHTML_context = nuevoHTML_context.replace('value=""', 'value="NA"').replace('value=""', 'value="NA"');
                                var nuevoHTML_context = `${nuevoHTML_context}
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts" style="display: none">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Lot intern :</b></span>
                                        <input type="text" class="form-control" id="internal_lot0_${i}" aria-label="TTN" value="${internal_lot}">
                                    </div>
                                </div>
                                <div class="col-lg-12 col-md-12 col-sm-12" name="divs_subproducts">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Unitats lot :</b></span>
                                        <select class="form-select" id="units_lot0_${i}">
                                            <option selected>1</option>
                                            {% for i in range(2, 5001) %}
                                                <option>{{ i }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Format compra :</b></span>
                                        <input type="text" class="form-control" id="purchase_format0_${i}" aria-label="TTN" value="${list_info_lots[i]['purchase_format']}" readonly>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Unitats format :</b></span>
                                        <input type="text" class="form-control" id="units_format0_${i}" aria-label="TTN" value="${list_info_lots[i]['units_format']}" readonly>
                                    </div>
                                </div>
                                <div class="col-lg-12 col-md-12 col-sm-12" name="divs_subproducts" style="display: none">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 100%;"><b>La conservació d'aquest article s'ha de fer a ${temperature}</b></span>
                                    </div>
                                </div>
                                <input type='hidden' id='json_info_lot0_${i}' value='${dict_lots}' name="divs_subproducts">
                                `;}
                            else {
                                if (list_info_lots[i]['description'].includes("Coriels") || list_info_lots[i]['description'].includes("Oligos")) {
                                    var nuevoHTML_context = nuevoHTML_context.replace('value=""', 'value="NA"').replace('value=""', 'value="NA"');
                                }
                                var nuevoHTML_context = `${nuevoHTML_context}
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Lot intern :</b></span>
                                        <input type="text" class="form-control" id="internal_lot0_${i}" aria-label="TTN" value="${internal_lot}">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Unitats lot :</b></span>
                                        <select class="form-select" id="units_lot0_${i}">
                                            <option selected>1</option>
                                            {% for i in range(2, 1001) %}
                                                <option>{{ i }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Format compra :</b></span>
                                        <input type="text" class="form-control" id="purchase_format0_${i}" aria-label="TTN" value="${list_info_lots[i]['purchase_format']}" readonly>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Unitats format :</b></span>
                                        <input type="text" class="form-control" id="units_format0_${i}" aria-label="TTN" value="${list_info_lots[i]['units_format']}" readonly>
                                    </div>
                                </div>
                                <div class="col-lg-12 col-md-12 col-sm-12" name="divs_subproducts">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 100%;"><b>La conservació d'aquest article s'ha de fer a ${temperature}</b></span>
                                    </div>
                                </div>
                                <input type='hidden' id='json_info_lot0_${i}' value='${dict_lots}' name="divs_subproducts">
                                `;
                            }
                            if (list_info_lots[i]['description_subreference'] === '' || list_info_lots[i]['description_subreference'] === null || list_info_lots[i]['description_subreference'] === undefined){ 
                                var nuevoHTML = nuevoHTML_variable + nuevoHTML_context}
                            else { var nuevoHTML = nuevoHTML_variable2 + nuevoHTML_context }
                            // Agrega el nuevo conjunto debajo del div existente
                            miDiv.insertAdjacentHTML('beforebegin', nuevoHTML);}

                        $('#add_lot_info').modal('show');
                        }}
                else if (split_response === 'False'){
                    message = "La cerca del lot ha fallat."
                    alert_type = 'danger'} 
                else{
                    message = "Error inesperat."
                    alert_type = 'danger'}}
            else {
                message = "Error, No s'ha pogut realitzar l'operació."
                alert_type = 'danger' }
            
            if (message !== ''){
                var flashContainer = document.querySelector(".d-flex.justify-content-center .row");
                // Eliminar la alerta anterior, si existe
                if (flashContainer.children.length > 0) {
                    flashContainer.removeChild(flashContainer.children[0]); }

                var newFlash = document.createElement("div");
                newFlash.className = "alert alert-" + alert_type + " alert-dismissible fade show ml-3";
                newFlash.role = "alert";
                newFlash.innerHTML = "<span>" + message + "</span>" + 
                                    '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                                    '<span aria-hidden="true">&times;</span>' +
                                    '</button>';
                flashContainer.appendChild(newFlash);
                flashContainer.style.paddingTop = "20px";}
        }

        xhr.send(form_data)
    }

    
    /**
     * Afegeix un nombre específic de nous lots al modal.
     * 
     * Aquesta funció elimina els lots anteriors i afegeix un nombre específic de
     * nous lots al modal. Per a cada lot, es proporcionen camps per a la identificació
     * de la subreferència, la temperatura de conservació, si és reactiu o fungible, i
     * una descripció de la subreferència.
     * 
     * @param {number} number_references El nombre de nous lots a afegir al modal.
     * @returns {void} No retorna cap valor.
     * 
     * @descriptor Aquesta funció executa diverses accions, com ara eliminar els lots
     * anteriors, generar camps HTML per als nous lots i afegir-los al modal.
     */
     function add_more_lots_in_modal(number_references){
        // Eliminar tots els div amb el name divs_subproduct
        var elementosAEliminar = document.querySelectorAll('div[name="divs_new_lots"]');
        elementosAEliminar.forEach(function(elemento) {
            elemento.remove(); });

        // obtenir i formatar la data
        var miDiv = document.getElementById('div_info_new_lot');

        for (var x = 0; x < number_references; x++){
            var nuevoHTML = `
                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>ID subreferencia :</b></span>
                        <input type="text" class="form-control" id='id_reactiu${x}' aria-label="TTN" aria-describedby="basic-addon1"">
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Temp. conservació :</b></span>
                        <select class="form-select" id="temp_conservation${x}">
                            <option>-20</option>
                            <option>-80</option>
                            <option>Ambient</option>
                            <option>4</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Reactiu o fungible :</b></span>
                            <select class="form-select" id="react_or_fungible${x}">
                                <option>Reactiu</option>
                                <option>Fungible</option>
                            </select>
                        </div>
                    </div>
                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Id panell(*) :</b></span>
                        <input type="text" class="form-control" aria-label="TTN" id="code_panel${x}">
                    </div>
                </div>
                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Ubicació :</b></span>
                        <select class="form-select" id="location${x}">
                            <option selected></option>
                            <option>Lab1-Extracció</option>
                            <option>Lab2-AP</option>
                            <option>Lab3-Màquines</option>
                            <option>Lab4-PCR</option>
                            <option>Lab5-PrePCR</option>
                            <option>Lab Cuina</option>
                            <option>Magatzem</option>
                            <option>Magatzem Fred</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-12 col-md-12 col-sm-12" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Descripció Subref. :</b></span>
                        <input type="text" class="form-control" id='description_subreference${x}' aria-label="TTN" aria-describedby="basic-addon1">
                    </div>
                </div>
                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_new_lots">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Format compra :</b></span>
                        <select class="form-select" id="purchase_format${x}">
                            <option selected></option>
                            <option>kit</option>
                            <option>caixa</option>
                            <option>ampolla</option>
                            <option>bossa</option>
                            <option>rotlle</option>
                            <option>unitats</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_new_lots">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Unitats format :</b></span>
                        <select class="form-select" id="units_format${x}">
                            <option selected>1</option>
                            {% for i in range(2, 101) %}
                                <option>{{ i }}</option>
                            {% endfor %}                            
                        </select>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Import u. ICS :</b></span>
                        <input type="number" class="form-control" aria-label="TTN" id="import_unit_ics${x}">
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Import u. IDIBGI :</b></span>
                        <input type="number" class="form-control" aria-label="TTN" id="import_unit_idibgi${x}">
                    </div>
                </div>
                `;

                // Agrega el nuevo conjunto debajo del div existente
                miDiv.insertAdjacentHTML('afterend', nuevoHTML);
                
            var number_lot =  number_references - x
            var HTML = `
                <div class="col-lg-5 col-md-12 col-sm-12" name="divs_new_lots">
                    <hr>
                </div>
                <div class="col-lg-2 col-md-12 col-sm-12" name="divs_new_lots">
                    <center>Article ${number_lot}</center>
                </div>
                <div class="col-lg-5 col-md-12 col-sm-12" name="divs_new_lots">
                    <hr>
                </div>
            `;

            // Agrega el nuevo conjunto debajo del div existente
            miDiv.insertAdjacentHTML('afterend', HTML);
        }

        if (number_references === '0'){
            // Eliminar tots els div amb el name divs_subproduct
            var elementosAEliminar = document.querySelectorAll('div[name="divs_new_lots"]');
            elementosAEliminar.forEach(function(elemento) {
                elemento.remove(); });

            var nuevoHTML = `
                <div class="col-lg-6 col-md-6 col-sm-12 divs_reatives" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Temp. conservació :</b></span>
                        <select class="form-select" id="temp_conservation0">
                            <option>-20</option>
                            <option>-80</option>
                            <option>Ambient</option>
                            <option>4</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Reactiu o fungible :</b></span>
                        <select class="form-select" id="react_or_fungible0" onchange="show_reactive(this.value)">
                            <option>Reactiu</option>
                            <option>Fungible</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12 divs_reatives" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Id panell(*) :</b></span>
                        <input type="text" class="form-control" aria-label="TTN" id="code_panel0">
                    </div>
                </div>
                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Ubicació :</b></span>
                        <select class="form-select" id="location0">
                            <option selected></option>
                            <option>Lab1-Extracció</option>
                            <option>Lab2-AP</option>
                            <option>Lab3-Màquines</option>
                            <option>Lab4-PCR</option>
                            <option>Lab5-PrePCR</option>
                            <option>Lab Cuina</option>
                            <option>Magatzem</option>
                            <option>Magatzem Fred</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_new_lots">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Format compra :</b></span>
                        <select class="form-select" id="purchase_format0">
                            <option selected></option>
                            <option>kit</option>
                            <option>caixa</option>
                            <option>ampolla</option>
                            <option>bossa</option>
                            <option>rotlle</option>
                            <option>unitats</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_new_lots">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Unitats format :</b></span>
                        <select class="form-select" id="units_format0">
                            <option selected>1</option>
                            {% for i in range(2, 101) %}
                                <option>{{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Import u. ICS :</b></span>
                        <input type="number" class="form-control" aria-label="TTN" id="import_unit_ics0">
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Import u. IDIBGI :</b></span>
                        <input type="number" class="form-control" aria-label="TTN" id="import_unit_idibgi0">
                    </div>
                </div>
                `;

            // Agrega el nuevo conjunto debajo del div existente
            miDiv.insertAdjacentHTML('afterend', nuevoHTML);
        }
    }


    /**
     * Afegeix un nombre específic de línies al modal per introduir referències.
     * 
     * Aquesta funció elimina les referències anteriors i afegeix un nombre específic
     * de línies al modal per introduir referències. Cada línia conté camps per a la 
     * descripció, el lot, la data de caducitat, el lot intern i les unitats del lot.
     * 
     * @param {number} number_references El nombre de línies que es vol afegir al modal.
     * @returns {void} No retorna cap valor.
     * 
     * @descriptor Aquesta funció executa diverses accions, com ara eliminar les referències
     * anteriors, obtenir la data actual i formatar-la, i generar l'estructura HTML per a les
     * noves línies del modal.
     */
    function add_more_lines_in_modal(number_references){
        // Eliminar tots els div amb el name divs_subproduct
        var elementosAEliminar = document.querySelectorAll('div[name="divs_subproducts"], input[name="divs_subproducts"]');
        elementosAEliminar.forEach(function(elemento) {
            elemento.remove(); });

        // obtenir i formatar la data
        // var current_date = new Date();
        // var day = current_date.getDate();
        // var month = current_date.getMonth() + 1;
        // var year = current_date.getFullYear();
        // day = day < 10 ? '0' + day : day;
        // month = month < 10 ? '0' + month : month;
        // var formated_date = day + '-' + month + '-' + year;
        // var internal_lot = year + month + day

        // document.getElementById('date_recepcion_lot').value = formated_date;

        date_receptin_value = document.getElementById('date_recepcion_lot').value;

        var regex = /^\d{2}-\d{2}-\d{4}$/;
        // Verificar si el string cumple con el formato
        if (regex.test(date_receptin_value)) {
            split_date = date_receptin_value.split('-')
            var internal_lot = `${split_date[2]}${split_date[1]}${split_date[0]}`
        } else {
            alert("La data no te el format correcta, ha de ser dd-mm-yyyy")
            return
        }

        var miDiv = document.getElementById('div_info_lot');
        for (var x = 0; x < number_references; x++){
            var number_lot =  x + 1
            var HTML = `
                <div class="col-lg-5 col-md-12 col-sm-12" name="divs_subproducts">
                    <hr>
                </div>
                <div class="col-lg-2 col-md-12 col-sm-12" name="divs_subproducts">
                    <center>Article ${number_lot}</center>
                </div>
                <div class="col-lg-5 col-md-12 col-sm-12" name="divs_subproducts">
                    <hr>
                </div>
            `;

            // Agrega el nuevo conjunto debajo del div existente
            miDiv.insertAdjacentHTML('beforebegin', HTML);
            for (var i = 0; i < list_info_lots.length; i++) {
                var temperature = ''
                var dict_lots = JSON.stringify(list_info_lots[i]);
                if (list_info_lots[i]['temp_conservation'] == '4'){
                    temperature = `+${list_info_lots[i]['temp_conservation']} °C`}
                else if (list_info_lots[i]['temp_conservation'] == '-20'){
                    temperature = `${list_info_lots[i]['temp_conservation']} °C`}
                else if (list_info_lots[i]['temp_conservation'] == '-80'){
                    temperature = `${list_info_lots[i]['temp_conservation']} °C`}
                else{
                    temperature = `${list_info_lots[i]['temp_conservation']}`}
                var nuevoHTML_variable = `<div class="col-lg-12 col-md-12 col-sm-12" name="divs_subproducts" style="display: none;">`
                var nuevoHTML_variable2 = `<div class="col-lg-12 col-md-12 col-sm-12" name="divs_subproducts">`
                var nuevoHTML_context = `
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 145px;"><b>Descripció:</b></span>
                            <input type="text" class="form-control" aria-label="TTN" id="description${x}_${i}" value="${list_info_lots[i]['id_reactive']} || ${list_info_lots[i]['description_subreference']}" readonly>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 145px;"><b>Lot :</b></span>
                            <input type="text" class="form-control" id="lot${x}_${i}" aria-label="TTN" value="">
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">  
                        <div class='input-group mb-3'>
                            <span class='input-group-text' id='basic-addon1' style='width: 145px;'><b>Data caducitat :</b></span>
                            <input type='text' class='form-control' id='expiry_date${x}_${i}' aria-label='TTN' aria-describedby='basic-addon1' oninput="replae_slash_with_hyphen(this); filter_characters(this)" value="">
                        </div>
                    </div>
                    `
                    if (list_info_lots[i]['react_or_fungible'] == 'Fungible'){
                        var nuevoHTML_context = nuevoHTML_context.replace('value=""', 'value="NA"').replace('value=""', 'value="NA"');
                        var nuevoHTML_context = `${nuevoHTML_context}
                            <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts" style="display: none;">
                                <div class="input-group mb-3">
                                    <span class="input-group-text" id="basic-addon1" style="width: 145px;"><b>Lot intern :</b></span>
                                    <input type="text" class="form-control" id="internal_lot${x}_${i}" aria-label="TTN" value="${internal_lot}">
                                </div>
                            </div>
                            <div class="col-lg-12 col-md-12 col-sm-12" name="divs_subproducts">
                                <div class="input-group mb-3">
                                    <span class="input-group-text" id="basic-addon1" style="width: 145px;"><b>Unitats lot :</b></span>
                                    <select class="form-select" id="units_lot${x}_${i}">
                                        <option selected>1</option>
                                        {% for i in range(2, 5001) %}
                                            <option>{{ i }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                <div class="input-group mb-3">
                                    <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Format compra :</b></span>
                                    <input type="text" class="form-control" id="purchase_format${x}_${i}" aria-label="TTN" value="${list_info_lots[i]['purchase_format']}" readonly>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                <div class="input-group mb-3">
                                    <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Unitats format :</b></span>
                                    <input type="text" class="form-control" id="units_format${x}_${i}" aria-label="TTN" value="${list_info_lots[i]['units_format']}" readonly>
                                </div>
                            </div>
                            <div class="col-lg-12 col-md-12 col-sm-12" name="divs_subproducts" style="display: none;">
                                <div class="input-group mb-3">
                                    <span class="input-group-text" id="basic-addon1" style="width: 100%;"><b>La conservació d'aquest article s'ha de fer a ${temperature}</b></span>
                                </div>
                            </div>
                            <input type='hidden' id='json_info_lot${x}_${i}' value='${dict_lots}' name="divs_subproducts">`;}
                    else {
                        if (list_info_lots[i]['description'].includes("Coriels") || list_info_lots[i]['description'].includes("Oligos")) {
                            var nuevoHTML_context = nuevoHTML_context.replace('value=""', 'value="NA"').replace('value=""', 'value="NA"');
                        }
                        var nuevoHTML_context = `${nuevoHTML_context}
                            <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                <div class="input-group mb-3">
                                    <span class="input-group-text" id="basic-addon1" style="width: 145px;"><b>Lot intern :</b></span>
                                    <input type="text" class="form-control" id="internal_lot${x}_${i}" aria-label="TTN" value="${internal_lot}">
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                <div class="input-group mb-3">
                                    <span class="input-group-text" id="basic-addon1" style="width: 145px;"><b>Unitats lot :</b></span>
                                    <select class="form-select" id="units_lot${x}_${i}">
                                        <option selected>1</option>
                                        {% for i in range(2, 1001) %}
                                            <option>{{ i }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                <div class="input-group mb-3">
                                    <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Format compra :</b></span>
                                    <input type="text" class="form-control" id="purchase_format${x}_${i}" aria-label="TTN" value="${list_info_lots[i]['purchase_format']}" readonly>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12" name="divs_subproducts">
                                <div class="input-group mb-3">
                                    <span class="input-group-text" id="basic-addon1" style="width: 148px;"><b>Unitats format :</b></span>
                                    <input type="text" class="form-control" id="units_format${x}_${i}" aria-label="TTN" value="${list_info_lots[i]['units_format']}" readonly>
                                </div>
                            </div>
                            <div class="col-lg-12 col-md-12 col-sm-12" name="divs_subproducts">
                                <div class="input-group mb-3">
                                    <span class="input-group-text" id="basic-addon1" style="width: 100%;"><b>La conservació d'aquest article s'ha de fer a ${temperature}</b></span>
                                </div>
                            </div>
                            <input type='hidden' id='json_info_lot${x}_${i}' value='${dict_lots}' name="divs_subproducts">
                        `;}
                if (list_info_lots[i]['description_subreference'] === '' || list_info_lots[i]['description_subreference'] === null || list_info_lots[i]['description_subreference'] === undefined){ 
                    var nuevoHTML = nuevoHTML_variable + nuevoHTML_context}
                else { var nuevoHTML = nuevoHTML_variable2 + nuevoHTML_context }

                // Agrega el nuevo conjunto debajo del div existente
                miDiv.insertAdjacentHTML('beforebegin', nuevoHTML);
            }
        }
    }

   
    /**
     * Afegeix un nou lot al sistema a partir de les dades introduïdes en un formulari modal.
     * 
     * Aquesta funció recopila les dades introduïdes en el formulari modal per afegir un nou lot
     * al sistema. Verifica si els camps necessaris estan omplerts correctament i, si és així, envia
     * les dades a través d'una sol·licitud AJAX al servidor per a la inserció del lot a la base de dades.
     * 
     * @returns {void} No retorna cap valor.
     * 
     * @descriptor Aquesta funció recull les dades del formulari modal, verifica si estan correctament omplertes,
     * crea un objecte FormData per a l'enviament a través d'una sol·licitud AJAX i gestiona la resposta del servidor.
     */
    function add_new_lot(){
        // Crear form data
        var form_data = new FormData();

        // Carregar dades al form de l'html
        const num_lots = document.getElementById('num_lots').value
        const reference_catalog = document.getElementById('reference_catalog').value
        const code_sap = document.getElementById('code_sap').value
        const code_log = document.getElementById('code_log').value
        let analytical_technique = document.getElementById('analytical_technique').value
        let manufacturer = document.getElementById('manufacturer').value
        const description = document.getElementById(`description`).value
        const supplier = document.getElementById(`supplier`).value
        
        if (reference_catalog === code_sap || reference_catalog === code_log || code_sap === code_log && code_log !== '' && code_sap != '') {
            alert("Els camps ref. proveïdor, codi SAP i codi LOG no poden ser iguals")
            return } 

        var list_lots = []

        if (num_lots === '0'){
            let temp_conservation = document.getElementById('temp_conservation0').value
            var react_or_fungible = document.getElementById('react_or_fungible0').value
            var code_panel = document.getElementById('code_panel0').value
            var location = document.getElementById(`location0`).value
            var purchase_format = document.getElementById(`purchase_format0`).value
            var units_format = document.getElementById(`units_format0`).value
            var import_unit_ics = document.getElementById(`import_unit_ics0`).value
            var import_unit_idibgi = document.getElementById(`import_unit_idibgi0`).value

            if (import_unit_ics == ''){ import_unit_ics = '0'}
            if (import_unit_idibgi == ''){ import_unit_idibgi = '0'}
            
            // Si es un fungible aquest camps estaran en blanc i donarà error, per això hi posem --.
            if (react_or_fungible === 'Fungible'){
                temp_conservation = '--'
                analytical_technique = '--'
                manufacturer = '--'}
            
            // Aquí m'han fet treure la restricció de que el codi SAP i LOG siguin obligatoris
            // if (code_sap !== '' && code_log !== '' && analytical_technique !== '' && description !== '' && reference_catalog !== '' && manufacturer !== '' && location !== '') {
            if (analytical_technique !== '' && description !== '' && reference_catalog !== '' && manufacturer !== '' && location !== '' && purchase_format !== '') {
                // Si es un funbile hem de possar aquest camps en blanc.
                if (react_or_fungible === 'Fungible'){
                    temp_conservation = ''
                    analytical_technique = ''
                    manufacturer = ''}

                var dict_lots = {
                    code_sap: code_sap,
                    code_log: code_log,
                    id_reactiu: '',
                    analytical_technique: analytical_technique,
                    manufacturer: manufacturer,
                    description: description,
                    temp_conservation: temp_conservation,
                    react_or_fungible: react_or_fungible,
                    description_subreference: '',
                    code_panel: code_panel,
                    location: location,
                    supplier: supplier,
                    purchase_format: purchase_format,
                    units_format: units_format,
                    import_unit_ics: import_unit_ics,
                    import_unit_idibgi: import_unit_idibgi }; }
            else {  
                alert("No es poden deixar els camps sense omplir.")
                return
            }
            list_lots.push(dict_lots)
        }

        for (var x = 0; x < num_lots; x++){
            var id_reactiu = document.getElementById(`id_reactiu${x}`).value
            var description_subreference = document.getElementById(`description_subreference${x}`).value
            var temp_conservation = document.getElementById(`temp_conservation${x}`).value
            var react_or_fungible = document.getElementById(`react_or_fungible${x}`).value
            var code_panel = document.getElementById(`code_panel${x}`).value
            var location = document.getElementById(`location${x}`).value
            if (react_or_fungible === 'Reactiu'){
                var purchase_format = 'kit'
                var units_format = '1'
            } else {
                var purchase_format = document.getElementById(`purchase_format${x}`).value
                var units_format = document.getElementById(`units_format${x}`).value
            }
            var import_unit_ics = document.getElementById(`import_unit_ics${x}`).value
            var import_unit_idibgi = document.getElementById(`import_unit_idibgi${x}`).value

            if (id_reactiu !== '' && analytical_technique !== '' && description !== '' && reference_catalog !== '' && manufacturer !== '' && location !== '' && purchase_format !== '' && import_unit_ics !== '' && import_unit_idibgi !== '') {
                var dict_lots = {
                    code_sap: code_sap,
                    code_log: code_log,
                    id_reactiu: id_reactiu,
                    analytical_technique: analytical_technique,
                    manufacturer: manufacturer,
                    description: description,
                    temp_conservation: temp_conservation,
                    react_or_fungible: react_or_fungible,
                    description_subreference: description_subreference,
                    code_panel: code_panel,
                    location: location,
                    supplier: supplier,
                    purchase_format: purchase_format,
                    units_format: units_format,
                    import_unit_ics: import_unit_ics,
                    import_unit_idibgi: import_unit_idibgi }; }
            else {
                alert("No es poden deixar els camps sense omplir.")
                return
            }
            list_lots.push(dict_lots)
        }

        var jsonData = JSON.stringify(list_lots);

        form_data.append('reference_catalog', reference_catalog)
        form_data.append('list_lots', jsonData)

        $('#add_new_lot').modal('hide');

        // Creeem l'objecte per l'ajax
        var xhr = new XMLHttpRequest();
        // 1er argument si es pots o get
        // 2n argument url o ruta
        // 3r argumemt true sempre
        xhr.open('POST', '/register_new_lot', true);
        xhr.onload = function(){
            if (xhr.status === 200) {
                var response = xhr.responseText;
                if (response.includes('False')){
                    alert_type = 'danger'
                    if (response === 'False_duplicate'){
                        message = `Error, un o més lots ja estan entrats a la bd, no s'ha inserit cap camp, revisa els duplicats i tornar a inserir-lo. <button type="button" class="btn btn-link btn-sm" onclick="open_modal('add_new_lot')">lot</button>`}
                    else{
                        message = `Error, no s'ha pogut inserir el lot a la bd. <button type="button" class="btn btn-link btn-sm" onclick="open_modal('add_new_lot')">lot</button>`}}
                else if (response === 'True'){
                    message = "El lot s'ha introduït correctament."
                    alert_type = 'success'} 
                else{
                    message = `Error inesperat. <button type="button" class="btn btn-link btn-sm" onclick="open_modal('add_new_lot')">lot</button>`
                    alert_type = 'danger'}}
            else {
                message = `Error, No s'ha pogut realitzar l'operació. <button type="button" class="btn btn-link btn-sm" onclick="open_modal('add_new_lot')">lot</button>`
                alert_type = 'danger' }

            var flashContainer = document.querySelector(".d-flex.justify-content-center .row");
            // Eliminar la alerta anterior, si existe
            if (flashContainer.children.length > 0) {
                flashContainer.removeChild(flashContainer.children[0]); }

            var newFlash = document.createElement("div");
            newFlash.className = "alert alert-" + alert_type + " alert-dismissible fade show ml-3";
            newFlash.role = "alert";
            newFlash.innerHTML = "<span>" + message + "</span>" + 
                                '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                                '<span aria-hidden="true">&times;</span>' +
                                '</button>';
            flashContainer.appendChild(newFlash);
            flashContainer.style.paddingTop = "20px";
        }

        xhr.send(form_data)
    }

    
    /**
     * Afegeix informació a la BD stock_lots utilitzant les dades introduïdes en un modal.
     * Realitza validacions del format de data i assegura que els camps requerits no estiguin buits.
     * Un cop s'ha realitzar l'operació mostra un missatge per pantalla a l'usuari.
     * 
     * @returns {void} No retorna cap valor.
     * 
     * @descriptor Aquesta funció afegeix informació sobre els lots al magatzem a partir de les dades introduïdes en un modal.
     * També realitza validacions del format de data i assegura que els camps requerits no estiguin buits abans de l'enviament de les dades.
     */
    function add_stock_lot(){
        var check_format_date = /^[0-3]\d-[01]\d-[2][0][2-4]\d$/;
        // Crear form data
        var form_data = new FormData();
        
        // Carregar dades al form de l'html
        const unit_lots = document.getElementById('unit_lots').value
        const date_recepcion_lot = document.getElementById('date_recepcion_lot').value
        if (!check_format_date.test(date_recepcion_lot)) {
            alert("El format de la data no és correcta, ha de ser dd-mm-yyyy");
            return }

        const transport_conditions = document.getElementById('transport_conditions').value
        const packaging = document.getElementById('packaging').value
        const inspected_by = document.getElementById('inspected_by').value
        const date_inspected = document.getElementById('date_inspected').value
        const observations_inspection = document.getElementById('observations_inspection').value
        const state = document.getElementById('state').value
        const comand_number = document.getElementById('comand_number').value
        const revised_by = document.getElementById('revised_by').value
        const date_revised = document.getElementById('date_revised').value
        const cost_center_stock = document.getElementById('cost_center_stock').value
        const id_command = document.getElementById('id_command').value
        const user_add_command = document.getElementById('user_add_command').value      

        // Obtener el elemento <select>
        var select_element = document.getElementById('select_substract_lot');
        var id_substract_command = 'none';

        // Verificar si el <select> tiene opciones
        if (select_element.options.length > 0) {
            // Obtener el valor de la opción seleccionada
            var id_substract_command = select_element.value;
        }

        if (transport_conditions === '' || packaging === '' || inspected_by === '' || date_inspected === '' || state === '' || comand_number === '' || revised_by === '' || date_revised === '' || cost_center_stock === ''){
            alert("No pots deixar camps buits, revisa els camps de recepció de procute i QC recepció.")
            return }
        
        if (!check_format_date.test(date_inspected)) {
            alert("El format de la data no és correcta, ha de ser dd-mm-yyyy");
            return }

        if (!check_format_date.test(date_revised)) {
            alert("El format de la data no és correcta, ha de ser dd-mm-yyyy");
            return }

        const file_delivery_note_input = document.getElementById('file_delivery_note')
        const file_delivery_note = file_delivery_note_input.files[0];
        const file_certificate_input = document.getElementById('file_certificate')
        const file_certificate = file_certificate_input.files[0];

        var list_lots = []
        // var unit_total_command = 0
        var dict_units_command = {}
        
        for (var x = 0; x < unit_lots; x++){
            for (var i = 0; i < list_info_lots.length; i++){
                const lot = document.getElementById(`lot${x}_${i}`).value
                const expiry_date = document.getElementById(`expiry_date${x}_${i}`).value
                const internal_lot = document.getElementById(`internal_lot${x}_${i}`).value
                const units_lot = document.getElementById(`units_lot${x}_${i}`).value
                const purchase_format = document.getElementById(`purchase_format${x}_${i}`).value
                const units_format = document.getElementById(`units_format${x}_${i}`).value
                if (!check_format_date.test(expiry_date) && !["NA", "--"].includes(expiry_date.toUpperCase())) {
                    alert("El format de la data no és correcta, ha de ser dd-mm-yyyy");
                    return }

                var total_units_lot = parseInt(units_lot, 10) * parseInt(units_format, 10);
                // var unit_total_command_aux = parseInt(unit_total_command) + parseInt(total_units_lot)
                // if (i == 0) {
                //     var unit_total_command = parseInt(unit_total_command) + parseInt(total_units_lot)
                // }

                if (lot !== '' && expiry_date !== '' && internal_lot !== ''){
                    const json_info_lot = document.getElementById(`json_info_lot${x}_${i}`).value
                    var dict_info_lot = JSON.parse(json_info_lot);
                    var id_reactive = dict_info_lot['id_reactive']
                    // 1 - si id_rectiu esta buit vol dir que es un article sense subreferncies, mirarem si el diccionar te 
                    //     units_command i si no la te la crearem amb total_units_lot com a value, si ja esta creat vol dir
                    //     que es un article el qual ha arribat amb mes d'un lot i haurem de sumar les unitats per saber el
                    //     total que ens ha arribat.
                    // 2 - Si id_reactiu no esta buit vol dir que es un article amb subprodutes, aqui farem servir l'id de
                    //     reatiu com a key i sumarem tots els valors, per saber el total de cada id_reactiu
                    if (id_reactive == ''){
                        if (dict_units_command.hasOwnProperty('units_commmand')) {
                            dict_units_command['units_commmand'] += total_units_lot;
                        } else {
                            dict_units_command['units_commmand'] = total_units_lot;
                        }
                    } else {
                        if (dict_units_command.hasOwnProperty(id_reactive)) {
                            dict_units_command[id_reactive] += total_units_lot;
                        } else {
                            dict_units_command[id_reactive] = total_units_lot;
                        }
                    }

                    dict_info_lot.reception_date = date_recepcion_lot
                    dict_info_lot.lot = lot
                    dict_info_lot.date_expiry = expiry_date 
                    dict_info_lot.internal_lot = internal_lot 
                    dict_info_lot.units_lot = total_units_lot
                    dict_info_lot.transport_conditions = transport_conditions
                    dict_info_lot.packaging = packaging
                    dict_info_lot.inspected_by = inspected_by
                    dict_info_lot.date_inspected = date_inspected
                    dict_info_lot.observations_inspection = observations_inspection
                    dict_info_lot.state = state
                    dict_info_lot.comand_number = comand_number
                    dict_info_lot.revised_by = revised_by
                    dict_info_lot.date_revised = date_revised
                    dict_info_lot.cost_center_stock = cost_center_stock
                    dict_info_lot.purchase_format = purchase_format 
                    dict_info_lot.units_format = units_format 
                    dict_info_lot.id_command = id_command,
                    dict_info_lot.user_add_command = user_add_command}
                else{
                    alert("No es poden deixar els camps sense omplir.") 
                    return}
                list_lots.push(dict_info_lot)}
        }
        var jsonData = JSON.stringify(list_lots);

        var unit_total_command = Math.max(...Object.values(dict_units_command));

        form_data.append('list_lots', jsonData)
        form_data.append('file_delivery_note', file_delivery_note)
        form_data.append('file_certificate', file_certificate)
        form_data.append('unit_total_command', unit_total_command)
        form_data.append('id_substract_command', id_substract_command)

        $('#add_lot_info').modal('hide');

        // Creeem l'objecte per l'ajax
        var xhr = new XMLHttpRequest();
        // 1er argument si es pots o get
        // 2n argument url o ruta
        // 3r argumemt true sempre
        xhr.open('POST', '/add_stock_lot', true);
        xhr.onload = function(){
            if (xhr.status === 200) {
                var response = xhr.responseText;
                if (response.includes('False')){
                    alert_type = 'danger'
                    if (response === 'False_duplicate'){
                        message = `Error, un o més lots ja estan entrats a la bd, no s'ha inserit cap camp, revisa els duplicats i tornar a inserir-lo. <button type="button" class="btn btn-link btn-sm" onclick="open_modal('add_lot_info')">lot</button>`}
                    else if (response === 'reactive'){
                        message = "Error, els reactius no poden sumar-se"}
                    else{
                        message = `Error, no s'ha pogut inserir el lot a la bd. <button type="button" class="btn btn-link btn-sm" onclick="open_modal('add_lot_info')">lot</button>`}}
                else if (response.includes('True')){
                    let text_command = response.replace("True_", "");
                    message = `El lot s'ha introduït correctament.<br>${text_command}`
                    alert_type = 'success'} 
                else{
                    message = `Error inesperat. <button type="button" class="btn btn-link btn-sm" onclick="open_modal('add_lot_info')">lot</button>`
                    alert_type = 'danger'}}
            else {
                message = `Error, no s'ha pogut realitzar l'operació. <button type="button" class="btn btn-link btn-sm" onclick="open_modal('add_lot_info')">lot</button>`
                alert_type = 'danger' }

            var flashContainer = document.querySelector(".d-flex.justify-content-center .row");
            // Eliminar la alerta anterior, si existe
            if (flashContainer.children.length > 0) {
                flashContainer.removeChild(flashContainer.children[0]); }

            var newFlash = document.createElement("div");
            newFlash.className = "alert alert-" + alert_type + " alert-dismissible fade show ml-3";
            newFlash.role = "alert";
            newFlash.innerHTML = "<span>" + message + "</span>" + 
                                '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                                '<span aria-hidden="true">&times;</span>' +
                                '</button>';
            flashContainer.appendChild(newFlash);
            flashContainer.style.paddingTop = "20px";
        }

        xhr.send(form_data)
    }


    /**
     * Mostra o amaga divs i canvia l'estil dels botons associats.
     * 
     * Aquesta funció controla la visibilitat dels divs especificats i canvia l'estil dels botons associats
     * per indicar el div visible. Per defecte, amaga el div2 i mostra el div1, canviant els estils dels botons
     * btn1 i btn2. Si el paràmetre 'show' és 'show', es mostra addicionalment el div amb l'id 'add_div'.
     * 
     * @param {string} div1 Id del primer div a mostrar.
     * @param {string} div2 Id del segon div a amagar.
     * @param {string} btn1 Id del primer botó a destacar.
     * @param {string} btn2 Id del segon botó a destacar.
     * @param {string} show Indica si es mostra addicionalment el div amb l'id 'add_div' ('show' o 'hide').
     * @returns {void} No retorna cap valor.
     * 
     * @descriptor Aquesta funció controla la visibilitat de diversos divs a la interfície de l'usuari.
     * Permet alternar entre dos divs mostrant-ne un i amagant l'altre, i canvia l'estil dels botons per
     * reflectir el div visible. També pot mostrar addicionalment un tercer div si s'especifica el paràmetre
     * 'show' com a 'show'.
     */
    function show_div_product(div1, div2, btn1, btn2, show){
        document.getElementById(div2).classList.add('d-none');
        document.getElementById(div1).classList.remove('d-none');

        document.getElementById(btn1).classList.remove('btn-secondary');
        document.getElementById(btn1).classList.add('btn-primary');
        document.getElementById(btn2).classList.remove('btn-primary');
        document.getElementById(btn2).classList.add('btn-secondary');

        if (show == 'show'){
            document.getElementById('add_div').style.display = 'block';
        }
    }


    /**
     * Mostrar o oculta un div
     * 
     * @param {string} div_panel Id del div.
     * @returns {void} No retorna cap valor.
     * 
     * @descriptor Agafem l'element amb l'id que ens han passat per paràmetre, comprobem el seu style i així
     * sabre si esta ocult o no, si esta ocult el posem visible i si esta visible el posem en ocult.
     */
    function show_panel_input(div_panel){
        // Obtener el elemento por su ID
        var element = document.getElementById(div_panel);
        var estiloDisplay = window.getComputedStyle(element).display;
        // Verificar si el estilo de visualización es 'block' o 'none' y hacer algo en consecuencia
        document.getElementById('code_panel').value = '';
        document.getElementById('code_panel_search').value = '';
        document.getElementById('code_panel_command').value = '';
        if (estiloDisplay === 'block') {
            document.getElementById(div_panel).style.display = 'none';
        } else if (estiloDisplay === 'none') {
            document.getElementById(div_panel).style.display = 'block';
        }
    }


    /**
     * Obra el modal, oculata un div i posa en blanc un value.
     * 
     * @returns {void} No retorna cap valor.
     * 
     * @descriptor Obrim el modal search_lot, despres ens asegurem qeu el div div_panel_search esta ocult i
     * per últim posarem en blanc el camp code_panel_search.
     */
    // function open_search_lot(){
    //     open_modal('search_lot')
    //     document.getElementById('code_panel_search').value = ''
    //     document.getElementById('div_panel_search').style.display = 'none';
    // }


    function actualizarOtrosInputs(value){
        // Expresión regular para el formato "dd-mm-yyyy"
        var regex = /^\d{2}-\d{2}-\d{4}$/;

        var unit_lots = document.getElementById("unit_lots").value;

        // Verificar si el string cumple con el formato
        if (regex.test(value)) {
            split_date = value.split('-')
            var internal_lot = `${split_date[2]}${split_date[1]}${split_date[0]}`

            for (var i = 0; i < unit_lots; i++) {
                for (var x = 0; x < 10; x++){
                    if (document.getElementById(`internal_lot${i}_${x}`)) {
                        document.getElementById(`internal_lot${i}_${x}`).value = internal_lot;
                    } 
                }
            }
        } else {
            alert("La data no te el format correcta, ha de ser dd-mm-yyyy")
            return
        }
    }


    /**
     * Envia una sol·licitud AJAX per saber si podem registrar una comanda.
     * 
     * @param {string} acronim Acronim de la sessió.
     * @returns {void} No retorna cap valor.
     * 
     * @descriptor Recollim el codi de cerca, assegurant-nos que l'usuari no el deixi en blanc. 
     * Si tot està correcte, enviem una sol·licitud AJAX per fer la consulta. Si la resposta indica
     * que no s'ha trobat cap coincidència amb el codi de cerca, obrim el modal de registrar article nou.
     * Si es troba una coincidència, les dades associades es posen en un diccionari i es presenten als
     * camps de l'HTML. Si es produeix qualsevol error durant el procés es mostra un missatge d'error.
     */
    function info_add_comand(acroni, rol){
        // Crear form data
        var form_data = new FormData();
        
        // Carregar dades al form de l'html
        const code_search = document.getElementById('code_search_command').value
        const code_panel = document.getElementById('code_panel_command').value


        var regex = /^\s*$/;
        var only_space = regex.test(code_search);
        if (only_space){alert("El camp no pot estar buït"); return}
        if (code_search.length < 3){alert("El codi no to tenir menys de 3 caràcters."); return }
                    
        form_data.append('code_search', code_search)
        form_data.append('code_panel', code_panel)

        // Creeem l'objecte per l'ajax
        var xhr = new XMLHttpRequest();
        // 1er argument si es pots o get
        // 2n argument url o ruta
        // 3r argumemt true sempre
        xhr.open('POST', '/search_add_command', true);
        xhr.onload = function(){
            if (xhr.status === 200) {
                var response = xhr.responseText;

                var split_response = response.split('_//_')
                
                close_modal('search_command') 

                if (split_response[0] === 'True'){
                    if (split_response[1] === 'new'){
                        if (rol === 'admin'){
                            show_reactive('')
                            // $('#add_command').modal('show'); 
                            // message = "Aquest article no esta intoduït, abans de fer comandes has d'introduïr-lo a la BD"
                            // alert_type = "warning"
                            message = ''
                            alert_type = ""
                        
                            document.getElementById("code_log").value = '';
                            document.getElementById("code_sap").value = '';
                            document.getElementById("manufacturer").value = '';
                            document.getElementById("analytical_technique").value = '';
                            document.getElementById("description").value = '';
                            document.getElementById('num_lots').value = 0;            
                            document.getElementById('reference_catalog').value = code_search;
                            document.getElementById("supplier").value = '';  

                            // Eliminar tots els divs amb el name divs_new_lots
                            var elementosAEliminar = document.querySelectorAll('div[name="divs_new_lots"]');
                                elementosAEliminar.forEach(function(elemento) {
                                    elemento.remove(); });

                            var miDiv = document.getElementById('div_info_new_lot');
                            var nuevoHTML = `
                                <div class="col-lg-6 col-md-6 col-sm-12 divs_reatives" name="divs_new_lots">       
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Temp. conservació :</b></span>
                                        <select class="form-select" id="temp_conservation0">
                                            <option>-20</option>
                                            <option>-80</option>
                                            <option>Ambient</option>
                                            <option>4</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Reactiu o fungible :</b></span>
                                        <select class="form-select" id="react_or_fungible0" onchange="show_reactive(this.value)">
                                            <option>Reactiu</option>
                                            <option>Fungible</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-12 divs_reatives" name="divs_new_lots">       
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Id panell(*) :</b></span>
                                        <input type="text" class="form-control" aria-label="TTN" id="code_panel0" value='${code_panel}'>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_new_lots">       
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Ubicació :</b></span>
                                        <select class="form-select" id="location0">
                                            <option selected></option>
                                            <option>Lab1-Extracció</option>
                                            <option>Lab2-AP</option>
                                            <option>Lab3-Màquines</option>
                                            <option>Lab4-PCR</option>
                                            <option>Lab5-PrePCR</option>
                                            <option>Lab Cuina</option>
                                            <option>Magatzem</option>
                                            <option>Magatzem Fred</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_new_lots">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Format compra :</b></span>
                                        <select class="form-select" id="purchase_format0">
                                            <option selected></option>
                                            <option>kit</option>
                                            <option>caixa</option>
                                            <option>ampolla</option>
                                            <option>bossa</option>
                                            <option>rotlle</option>
                                            <option>unitats</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12" name="divs_new_lots">
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Unitats format :</b></span>
                                        <select class="form-select" id="units_format0">
                                            <option selected>1</option>
                                            {% for i in range(2, 101) %}
                                                <option>{{ i }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Import u. ICS :</b></span>
                                        <input type="number" class="form-control" aria-label="TTN" id="import_unit_ics0">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-12" name="divs_new_lots">       
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Import u. IDIBGI :</b></span>
                                        <input type="number" class="form-control" aria-label="TTN" id="import_unit_idibgi0">
                                    </div>
                                </div>
                                `;
                            // Agrega el nuevo conjunto debajo del div existente
                            miDiv.insertAdjacentHTML('afterend', nuevoHTML);
                            $('#add_new_lot').modal('show'); } 
                        else { 
                            message = `L'article ${code_search} no està registrat, contacta amb un administrador perquè registri el producte.`
                            alert_type = 'warning'}}
                    else {
                        // Tranformem en diccionari el json
                        list_info_lots = JSON.parse(split_response[1]);
                        // Assignem els valors
                        document.getElementById("catalog_reference_command").value = list_info_lots['catalog_reference']
                        document.getElementById("code_sap_command").value = list_info_lots['code_SAP']
                        document.getElementById("code_loc_command").value = list_info_lots['code_LOG']
                        document.getElementById("description_command").value = list_info_lots['description']
                        document.getElementById("key_lot_command").value = list_info_lots['key']
                        document.getElementById("cost_center").value = '--'
                        document.getElementById("cost_center_name").value = ''
                        document.getElementById("div_ceco_manual").style.display ='none'
                        $('#add_command').modal('show'); 
                        message = '' }}
                else if (split_response === 'False'){
                    message = "La cerca del lot ha fallat."
                    alert_type = 'danger'} 
                else{
                    message = "Error inesperat."
                    alert_type = 'danger'}}
            else {
                message = "Error, No s'ha pogut realitzar l'operació."
                alert_type = 'danger' }

            if (message !== ''){
                var flashContainer = document.querySelector(".d-flex.justify-content-center .row");
                // Eliminar la alerta anterior, si existe
                if (flashContainer.children.length > 0) {
                    flashContainer.removeChild(flashContainer.children[0]); }

                var newFlash = document.createElement("div");
                newFlash.className = "alert alert-" + alert_type + " alert-dismissible fade show ml-3";
                newFlash.role = "alert";
                newFlash.innerHTML = "<span>" + message + "</span>" + 
                                    '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                                    '<span aria-hidden="true">&times;</span>' +
                                    '</button>';
                flashContainer.appendChild(newFlash);
                flashContainer.style.paddingTop = "20px";}
        }

        xhr.send(form_data)
    }

    
    /**
     * Afegeix informació a la BD commands utilitzant les dades introduïdes en un modal.
     * Comprovem que els camps requerits no estiguin buits.
     * Un cop s'ha realitzar l'operació mostra un missatge per pantalla a l'usuari.
     * 
     * @returns {void} No retorna cap valor.
     * 
     * @descriptor Aquesta funció afegeix comandes a partir de les dades introduïdes en un modal.
     * També realitza validacions i assegura que els camps requerits no estiguin buits abans de l'enviament de les dades.
     */
    function add_command(){
        // Crear form data
        var form_data = new FormData();
        
        // Carregar dades al form de l'html

        const key_lot = document.getElementById("key_lot_command").value
        const units_command = document.getElementById("units_command").value
        const cost_center = document.getElementById("cost_center").value
        const cost_center_name = document.getElementById("cost_center_name").value
        const observations_command = document.getElementById("observations_command").value
        let cost_center_final = ''
        let new_cost_center = false

        
        if (cost_center === '--' || cost_center === 'Intoduïr manualment' && cost_center_name === ''){
                alert("No es pot deixar el centre de cost buït")
                return}
        else if (cost_center === 'Intoduïr manualment'){
                new_cost_center = true
                cost_center_final = cost_center_name }
        else{ cost_center_final = cost_center }
        
        if (units_command === '0' || units_command === '' || units_command < 0){
            var divMessage = document.getElementById("div_message_command");
            if (divMessage) {divMessage.remove();}
        
            var html_insert = `
                <div class="d-flex justify-content-center" id="div_message_command">
                    <div class="row mt-1 justify-content-center">
                        <div class="alert alert-danger alert-dismissible fade show ml-3" role="alert">
                            <span>Has de posar un número d'unitats valid</span>
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            var div_ubication_comand = document.getElementById("flash_message_comand");
            // Insertar el HTML dentro del elemento objetivo
            div_ubication_comand.insertAdjacentHTML('beforebegin', html_insert);
            // var spanElement = document.querySelector('span[name="span_units_command"]');
            // spanElement.style.backgroundColor = 'red';
            return }
 
        form_data.append('key_lot', key_lot)
        form_data.append('units_command', units_command)
        form_data.append('cost_center', cost_center_final)
        form_data.append('new_cost_center', new_cost_center)
        form_data.append('observations_command', observations_command)

        $('#add_command').modal('hide');

        // Creeem l'objecte per l'ajax
        var xhr = new XMLHttpRequest();
        // 1er argument si es pots o get
        // 2n argument url o ruta
        // 3r argumemt true sempre
        xhr.open('POST', '/add_command', true);
        xhr.onload = function(){
            if (xhr.status === 200) {
                var response = xhr.responseText;
                if (response.includes('False')){
                    alert_type = 'danger'
                    if (response === 'False_duplicate'){
                        message = `Error, un o més lots ja estan entrats a la bd, no s'ha inserit cap camp, revisa els duplicats i tornar a inserir-lo.`}
                    else{
                        message = `Error, no s'ha pogut inserir el lot a la bd. <button type="button" class="btn btn-link btn-sm" onclick="open_modal('add_lot_info')">lot</button>`}}
                else if (response === 'True'){
                    message = "La comanda s'ha introduït correctament."
                    alert_type = 'success'} 
                else{
                    message = `Error inesperat.`
                    alert_type = 'danger'}}
            else {
                message = `Error, No s'ha pogut realitzar l'operació.`
                alert_type = 'danger' }

            var flashContainer = document.querySelector(".d-flex.justify-content-center .row");
            // Eliminar la alerta anterior, si existe
            if (flashContainer.children.length > 0) {
                flashContainer.removeChild(flashContainer.children[0]); }

            var newFlash = document.createElement("div");
            newFlash.className = "alert alert-" + alert_type + " alert-dismissible fade show ml-3";
            newFlash.role = "alert";
            newFlash.innerHTML = "<span>" + message + "</span>" + 
                                '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                                '<span aria-hidden="true">&times;</span>' +
                                '</button>';
            flashContainer.appendChild(newFlash);
            flashContainer.style.paddingTop = "20px";
        }

        xhr.send(form_data)
    }


    /**
     * Mostra o oculta els elements amb la classe `divs_reatives` basant-se en el tipus de reactiu especificat.
     * 
     * Aquesta funció ajusta la visibilitat dels elements de la pàgina web amb la classe `divs_reatives` segons 
     * el valor del paràmetre `type_reactive`. Si el valor és "Fungible", els elements es ocultaran. Si el valor 
     * és qualsevol altre cosa, els elements es mostraran.
     * 
     * @param {string} type_reactive - El tipus de reactiu que determina la visibilitat dels elements. 
     *                                 Si és "Fungible", els elements seran ocultats; si és qualsevol altre valor, 
     *                                 els elements seran mostrats.
     * 
     * @returns {void} No retorna cap valor. Modifica la visibilitat dels elements seleccionats.
     * 
     * @descriptor La funció ajusta la visibilitat de tots els elements amb la classe `divs_reatives` 
     * en funció del valor del paràmetre `type_reactive`. Utilitza `display: none` per ocultar els elements 
     * i `display: block` per mostrar-los.
     */
    function show_reactive(type_reactive){
        // Seleccionem tots els element amb la clase divs_reatives"
        var divsReatives = document.querySelectorAll('.divs_reatives');

        if (type_reactive == "Fungible"){
            // Iterem sobre l'element i l'ocultem
            divsReatives.forEach(function(div) {
                div.style.display = 'none'; 
            });}
        else{
            // Iterem sobre l'element i l'ocultem
            divsReatives.forEach(function(div) {
                div.style.display = 'block'; 
            });}
    }


    /**
     * Mostra o oculta un div segons l'opció seleccionada.
     * 
     * Aquesta funció ajusta la visibilitat del div amb l'ID `div_ceco_manual` basant-se en el valor del paràmetre 
     * `option`. Si l'opció és "Intoduïr manualment", el div es mostrarà i el camp de text `cost_center_name` 
     * serà esborrat. En cas contrari, el div serà ocultat.
     * 
     * @param {string} option - L'opció que determina si el div ha de ser mostrat o ocultat. 
     *                          Si és "Intoduïr manualment", el div serà mostrat; qualsevol altra opció farà que 
     *                          el div sigui ocultat.
     * 
     * @returns {void} No retorna cap valor. Modifica la visibilitat del div i el valor del camp de text.
     * 
     * @descriptor La funció utilitza el valor del paràmetre `option` per decidir si mostrar o ocultar el div 
     * amb l'ID `div_ceco_manual`. Si l'opció és "Intoduïr manualment", el div serà mostrat i el camp de text 
     * `cost_center_name` serà esborrat. Si no és així, el div serà ocultat.
     */
    function show_hide_div_ceco(option){
        if (option === "Intoduïr manualment"){
            document.getElementById('cost_center_name').value = '';
            document.getElementById('div_ceco_manual').style.display = 'block'; }
        else{
            document.getElementById('div_ceco_manual').style.display = 'none'}
    }

    /**
     * Fa el submit de un form
     */
    function download_template(){
        document.forms["down_excel"].submit();
    }


    /**
     * Carga un archivo de precios y lo envía al servidor para procesar.
     * 
     * Esta función permite cargar un archivo .xlsx a través de un formulario y lo envía mediante una solicitud
     * AJAX al servidor para su procesamiento. Realiza validaciones de formato y muestra un mensaje de alerta según el 
     * resultado de la operación.
     * 
     * @returns {void} No retorna ningún valor. Controla la carga de un archivo y gestiona las respuestas del servidor.
     * 
     * @descriptor La función verifica si se ha seleccionado un archivo en el campo de entrada con el ID `file`, 
     * luego valida si el archivo tiene una extensión válida .xlsx. Si todo es correcto, envía el archivo
     * al servidor mediante una solicitud AJAX POST a la ruta `/upload_template_price`. 
     * Dependiendo de la respuesta del servidor, se muestra un mensaje de éxito, advertencia o error.
     * 
     * La función gestiona también la interfaz de usuario, ocultando un modal y mostrando una alerta personalizada
     * según el resultado del proceso de carga.
     */
    function charge_doc_price(){
            // Crear form data
            var form_data = new FormData();

            // Carregar dades al form de l'html            
            const file_input = document.getElementById('file')
            const file = file_input.files[0];

            if (!file){
                alert("Selecciona un document, abans de clicar Carregar")
                return
            } else {
                const fileName = file.name; // Obtiene el nombre del archivo
                const fileExtension = fileName.split('.').pop().toLowerCase();

                // Verifica si la extensión es válida
                if (fileExtension !== 'xlsx') {
                    alert(`Format no valid: .${fileExtension}`);
                    return;
                }
            }
            
            form_data.append('file', file)

            $('#open_update_price').modal('hide');

            // Creeem l'objecte per l'ajax
            var xhr = new XMLHttpRequest();
            // 1er argument si es pots o get
            // 2n argument url o ruta
            // 3r argumemt true sempre
            
            xhr.open('POST', '/upload_template_price', true);
            xhr.onload = function(){
                if (xhr.status === 200) {
                    var response = xhr.responseText;
                    var split_response= response.split('_//_')
                    if (split_response[0] === 'False'){
                        alert_type = 'danger'
                        message = split_response[1]}
                    else if (split_response[0] === 'True'){
                        if (split_response[2] === 'False'){
                            message = "No hem detectat cap canvi ha fer amb el document carregat."
                            alert_type = 'warning'}
                        else if (split_response[1] === ''){
                            message = "El document s'ha carregat correctament."
                            alert_type = 'success'}
                        else {
                            message = `El document s'ha carregat però els seguent camps no s'han actualitzat.<br>${split_response[1]}.`
                            alert_type = 'warning'
                        }                        
                    } else {
                        message = `Error inesperat. Si persisteix l'error contacta amb un administrador`
                        alert_type = 'danger'
                    }
                }
                else {
                    message = `Error, No s'ha pogut realitzar l'operació. Si persisteix l'error contacta amb un administrador`
                    alert_type = 'danger' }

                var flashContainer = document.querySelector(".d-flex.justify-content-center .row");
                // Eliminar la alerta anterior, si existe
                if (flashContainer.children.length > 0) {
                    flashContainer.removeChild(flashContainer.children[0]); }

                var newFlash = document.createElement("div");
                newFlash.className = "alert alert-" + alert_type + " alert-dismissible fade show ml-3";
                newFlash.role = "alert";
                newFlash.innerHTML = "<span>" + message + "</span>" + 
                                    '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                                    '<span aria-hidden="true">&times;</span>' +
                                    '</button>';
                flashContainer.appendChild(newFlash);
                flashContainer.style.paddingTop = "20px";
            }

            xhr.send(form_data)
        }


    /**
    * Enviem una sol·licitud per ajax perquè ens retorni tota la informació de les comandes tramitades que estan pendents de recepció.
    *
    * @returns {void} No retorna cap valor.
    *
    * @descriptor Aquesta funció envia una sol·licitud AJAX al servidor per consultar les comandes tramitades que estan pendente de recepció.
    * Si ens retorna la informació la transformem en una taula de diccionaris i les inserim a la taula a l'html
    * Si ens retorna error mostrarem un missatge d'informació amb el resultat.
    */
    function order_tracking_no_admin(){
        alert_type = ''
        message = ''
        // Crear form data
        var form_data = new FormData();

        // Creeem l'objecte per l'ajax
        var xhr = new XMLHttpRequest();
        // 1er argument si es pots o get
        // 2n argument url o ruta
        // 3r argumemt true sempre
        xhr.open('POST', '/order_tracking', true);
        xhr.onload = function(){
        show_message = true
        if (xhr.status === 200) {
            var response = xhr.responseText;
            var split_response = response.split('_//_')
            if (split_response[0] === 'False'){
                message = split_response[1]
                alert_type = 'danger'}
            else if (split_response[0] === 'True'){
                $('#modal_order_tracking_no_admin').modal('show');

                var list_lots = JSON.parse(split_response[1]);

                var table = $('#table_order_tracking_no_admin').DataTable();
                table.clear().draw();

                for (var i = 0; i < list_lots.length; i++) {
                    var new_row_data = [];
                    // Crea un nuevo elemento td para cada valor en la lista
                    for (var key in list_lots[i]) {
                        if (list_lots[i].hasOwnProperty(key)) {
                            if (key !== 'id' && key !== 'id_lot') {
                                new_row_data.push(list_lots[i][key])}
                        }
                    }
                    var new_row = table.row.add(new_row_data).draw(false).node();
                    $(new_row).attr('id', list_lots[i].id) // Usa 'id' o 'id_lot' según corresponda
                                .addClass('open-modal')   // Añade la clase que desees
                                .attr('data-target', `${list_lots[i].id}_//_${list_lots[i].units}_//_${list_lots[i].observations}_//_${list_lots[i].catalog_reference}_//_${list_lots[i].cost_center}`);
                }
                // Aplicar estilos CSS para centrar el contenido de las primeras cuatro columnas
                for (var j = 0; j < 10; j++) {
                    if (j !== 1) {
                        table.column(j).nodes().to$().addClass('text-center');}
                }
            } else {
                message = `Error inesperat. Si persisteix l'error contacta amb un administrador`
                alert_type = 'danger'
            }
        }
        else {
            message = `Error, No s'ha pogut realitzar l'operació. Si persisteix l'error contacta amb un administrador`
            alert_type = 'danger' }
        
        if (message !== ''){
            var flashContainer = document.querySelector(".d-flex.justify-content-center .row");
            // Eliminar la alerta anterior, si existe
            if (flashContainer.children.length > 0) {
                flashContainer.removeChild(flashContainer.children[0]); }
            var newFlash = document.createElement("div");
            newFlash.className = "alert alert-" + alert_type + " alert-dismissible fade show ml-3";
            newFlash.role = "alert";
            newFlash.innerHTML = "<span>" + message + "</span>" + 
                                '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                                '<span aria-hidden="true">&times;</span>' +
                                '</button>';
            flashContainer.appendChild(newFlash);
            flashContainer.style.paddingTop = "20px";}
        }

        xhr.send(form_data)
    }


</script>
<style>
    #add_lot_info {
        overflow-y: auto;  /* Esto permitirá el scroll vertical si es necesario */
    }

    #add_new_lot {
        overflow-y: auto;  /* Esto permitirá el scroll vertical si es necesario */
    }

    /* Estilo para el botón icono */
    .icon-button {
        background-color: transparent;
        border: none;
        cursor: pointer;
        font-size: 16px; /* Tamaño del icono */
        color: #333; /* Color del icono */
        padding: 0; /* Elimina el relleno */
        color: blue;
    }
</style>
</head>

<body>
    {% include 'NavBar/navBar.html' %}
    {% include 'ErrorFlash/errorFlash.html' %}
    <div class="jumbotron bg-grey text-black jomboton-imgae shadow" style="width: 90%; margin: 0 auto;">
        <h1 class='mb-4' style="color: rgb(70, 70, 70); text-align: center;">Registre de rectius<hr></h1>
        <div class="d-flex justify-content-center">
            <div class="row">
                <div class="col-lg-3 col-md-6 col-sm-12">
                    <div class="row">
                        <div class="col-6" style="padding-top: 10px;">
                            <div class="card" style="width: 19rem;height:100%">
                                <div class="card-body">
                                    <h5 class="card-title"><b>1 - Comandes / Registra Art.</b></h5>
                                    <p class="card-text" style="font-size: 14px;">Inserir comanda nova, veure les pendents, poder eliminar-les i inserir productes nous</p>
                                    <button type="button" onclick="open_modal('search_command')" class="btn btn-outline-primary btn-sm">Inserir <i class="fa-solid fa-file-circle-plus"></i></button>
                                    {% if session['rol'] == 'admin' %}
                                        <form action="/search_commands" style="display: inline;">
                                            <button type="submit" class="btn btn-outline-success btn-sm">Consultar <i class="fa-solid fa-magnifying-glass"></i></button>
                                        </form>
                                    {% else %}
                                        <button class="btn btn-outline-success btn-sm" onclick="order_tracking_no_admin()">Seg. Comandes <i class="fa-solid fa-truck-arrow-right"></i></button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-12">
                    <div class="row">
                        <div class="col-6" style="padding-top: 10px;">
                            <div class="card" style="width: 19rem;height:100%">
                                <div class="card-body">
                                    <h5 class="card-title"><b>2 - Recepcionar articles </b></h5>
                                    <p class="card-text" style="font-size: 14px;">Afegir stock d'articles a la BD que ja tinguem registrats.</p>
                                    <button class="btn btn-outline-primary btn-sm" onclick="insert(`{{session['acronim']}}`)">Recepcionar <i class="fa-solid fa-list-check"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-12">
                    <div class="row">
                        <div class="col-6" style="padding-top: 10px;">
                            <div class="card" style="width: 19rem;height:100%">
                                <div class="card-body">
                                    <h5 class="card-title"><b>3 - Documents reactius</b></h5>
                                    <p class="card-text" style="font-size: 14px;">Descarregar-te un pdf amb els QC o introduir l'albarà i el certificat.</p>
                                    <button type="button" onclick="open_modal('search_lot')" class="btn btn-outline-primary btn-sm">Documents <i class="fa-solid fa-magnifying-glass"></i></button>
                                    <form action="/search_all_lots" method="post" style="display: inline;">
                                        <button type="submit" class="btn btn-outline-success btn-sm">Tots els Docs. <i class="fa-solid fa-book"></i></button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-12">
                    <div class="row">
                        <div class="col-6" style="padding-top: 10px;">
                            <div class="card" style="width: 19rem;height:100%">
                                <div class="card-body">
                                    <h5 class="card-title"><b>4 - Gestió d'articles</b></h5>
                                    <p class="card-text" style="font-size: 14px;">Obrir / tancar lots i consultar registres tant de reactiu com de fungibles</p>
                                    <button type="button" data-toggle="modal" data-target="#open_close_lot" class="btn btn-outline-primary btn-sm">Reactiu <i class="fa-solid fa-vial"></i></button>
                                    <button type="button" data-toggle="modal" data-target="#modal_search_fungible" class="btn btn-outline-success btn-sm">Fungible <i class="fa-solid fa-eye-dropper"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade"  id="add_lot" tabindex="-1" role="dialog" aria-labelledby="editRegister" aria-hidden="true">
        <div class="modal-dialog modal-lg" tabindex="-1" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="title">Recepcionar Article</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="close_modal('add_lot')"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <!-- <span class="input-group-text" id="basic-addon1"><b>Ref. proveïdor, SAP o LOG:</b></span> -->
                            <span class="input-group-text" id="basic-addon1" style="width: 233px;"><b>Ref. proveïdor o descripció :</b></span>
                            <input type="text" class="form-control" id='code_search' list="datalist-codes5" aria-label="TTN" aria-describedby="basic-addon1" value="lot1">
                            <datalist id="datalist-codes5">
                                {% for description in list_desciption_lots %}
                                    <option value="{{description.description}}">{{description.catalog_reference}} - {{ description.description }}</option>
                                {% endfor %}
                            </datalist>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="show_panel_input('div_panel')"><i class="fa-solid fa-plus"></i> panell</button>
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12" style="display: none;" id="div_panel">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 233px;"><b>Codi panell (*):</b></span>
                            <input type="text" class="form-control" id='code_panel' aria-label="TTN" aria-describedby="basic-addon1">
                        </div>
                    </div>
                    <center><button type="button" class="btn btn-primary btn-sm" onclick="info_add_lot(`{{session['acronim']}}`, `{{session['rol']}}`)">Accepta</button></center>
                </div>
            </div>
          </div>
        </div>
    </div>


    <div class="modal fade"  id="add_new_lot" tabindex="-1" role="dialog" aria-labelledby="editRegister" aria-hidden="true">
        <div class="modal-dialog modal-lg" tabindex="-1" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="title">Afegeix un nou article (dades comunes)</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="close_modal('add_new_lot')"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Ref. proveïdor :</b></span>
                            <input type="text" class="form-control" id='reference_catalog' aria-label="TTN" aria-describedby="basic-addon1">
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12 divs_reatives">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Subreferències :</b></span>
                            <select class="form-select" id="num_lots" onchange="add_more_lots_in_modal(this.value)">
                                <option selected>0</option>
                                {% for i in range(1, 15) %}
                                    <option>{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Codi SAP :&nbsp; </b><button class="icon-button" title="Segons albarà"><i class="fas fa-info-circle"></i></button></span>
                            <input type="text" class="form-control" id='code_sap' aria-label="TTN" aria-describedby="basic-addon1">
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Codi LOG :</b></span>
                            <input type="text" class="form-control" id='code_log' aria-label="TTN" aria-describedby="basic-addon1">
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12 divs_reatives">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Tècnica analítica :</b></span>
                            <!-- <input type="text" class="form-control" id='analytical_technique' aria-label="TTN" aria-describedby="basic-addon1"> -->
                            <select class="form-select" id="analytical_technique">
                                <option selected></option>
                                <option>Extracció</option>
                                <option>Genèric</option>
                                <option>Genotipat</option>
                                <option>MLPA</option>
                                <option>NGS</option>
                                <option>Oficina</option>
                                <option>qPCR</option>
                                <option>Sanger</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12 divs_reatives">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Fabricant :</b></span>
                            <input type="text" class="form-control" id='manufacturer' aria-label="TTN" aria-describedby="basic-addon1">
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Proveïdor :</b></span>
                            <input type="text" class="form-control" id='supplier' aria-label="TTN" aria-describedby="basic-addon1">
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 168px;"><b>Descripció :&nbsp; </b><button class="icon-button" title="Segons albarà"><i class="fas fa-info-circle"></i></button></span>
                            <input type="text" class="form-control" id='description' aria-label="TTN" aria-describedby="basic-addon1">
                        </div>
                    </div>

                    <div id="div_info_new_lot"></div>

                    <div class="col-lg-12 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <button type="button" class="btn btn-primary btn-sm" style="width: 168;" onclick="add_new_lot()"><i class="fa-solid fa-circle-plus"></i> Afegeix </button>
                        </div>
                    </div>
                </div>
            </div>
          </div>
        </div>
    </div>


    <div class="modal fade"  id="add_lot_info" tabindex="-1" role="dialog" aria-labelledby="editRegister" aria-hidden="true">
        <div class="modal-dialog modal-lg" tabindex="-1" role="document">
          <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex justify-content-center w-100">
                    <h5 class="modal-title" id="title" name="title_add_lots">Afegeix article</h5>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="close_modal('add_lot_info')"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-header">
                <div class="d-flex justify-content-center w-100">
                    <!-- <div class="text-center"> -->
                    <button type="button" class="btn btn-primary" id="btn_1" onclick="show_div_product('product_reception', 'qc_reception', 'btn_1', 'btn_2', '--')" style="margin-right: 10px;">Recepció producte</button>
                    <button type="button" class="btn btn-secondary" id="btn_2" onclick="show_div_product('qc_reception', 'product_reception', 'btn_2', 'btn_1', 'show')">QC recepció</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="row" id="info_command" style="display: none;">
                    <div class="col-lg-12 col-md-12 col-sm-12">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="text_info_command" style="width: 100%; background-color: lightgreen; display: flex; align-items: center; justify-content: center; text-align: center;"><b></b></span>
                        </div>
                    </div>
                </div>
                <div class="row" id="product_reception">
                    <div class="col-lg-12 col-md-12 col-sm-12" id="div_substract_lot" style="display: none;">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 145px;"><b>Lot a restar:</b></span>
                            <select class="form-select" id="select_substract_lot">
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12" id="div_substract_lot_hr" style="display: none; margin-top: -15px;">       
                        <hr>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 145px;"><b>Lots diferents:</b></span>
                            <select class="form-select" id="unit_lots" onchange="add_more_lines_in_modal(this.value)">
                                <option selected>1</option>
                                {% for i in range(2, 5) %}
                                    <option>{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 145px;"><b>Data recepció:</b></span>
                            <input type="text" class="form-control" id='date_recepcion_lot' aria-label="TTN" aria-describedby="basic-addon1" oninput="replae_slash_with_hyphen(this); filter_characters(this)" onchange="actualizarOtrosInputs(this.value)">
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 145px;"><b>Descripció:</b></span>
                            <input type="text" class="form-control" id="description_add_lot" aria-label="TTN" readonly>
                        </div>
                    </div>

                    <div id="div_info_lot"></div>

                    <center><button type="button" class="btn btn-primary btn-sm" onclick="add_stock_lot()" id="add_div" style="display: none;">Afegir</button></center>
                </div>
                <div class="row d-none" id="qc_reception">
                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 185px;"><b>Condicions transport :</b></span>
                            <select class="form-select" id="transport_conditions" >
                                <option selected></option>
                                <option>Correcta</option>
                                <option>Incorrecta</option>
                            </select>
                            <!-- <input type="text" class="form-control" id='transport_conditions' aria-label="TTN" aria-describedby="basic-addon1"> -->
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 140px;"><b>Embalatge :</b></span>
                            <select class="form-select" id="packaging" >
                                <option selected></option>
                                <option>Adequat</option>
                                <option>Inadequat</option>
                            </select>
                            <!-- <input type="text" class="form-control" id='packaging' aria-label="TTN" aria-describedby="basic-addon1"> -->
                        </div>
                    </div>

                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 185px;"><b>Inspeccionat per :</b></span>
                            <input type="text" class="form-control" id='inspected_by' aria-label="TTN" aria-describedby="basic-addon1">
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 140px;"><b>Data inspecció :</b></span>
                            <input type="text" class="form-control" id='date_inspected' aria-label="TTN" aria-describedby="basic-addon1" oninput="replae_slash_with_hyphen(this); filter_characters(this)">
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 185px;"><b>Obs. d'inspecció :</b></span>
                            <input type="text" class="form-control" id='observations_inspection' aria-label="TTN" aria-describedby="basic-addon1">
                        </div>
                    </div>

                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 185px;"><b>Estat :</b></span>
                            <select class="form-select" id="state">
                                <option>Acceptat</option>
                                <option>Rebutjat</option>
                                <option>Quarentena</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 140px;"><b>Num. comanda :</b></span>
                            <input type="text" class="form-control" id='comand_number' aria-label="TTN" aria-describedby="basic-addon1">
                        </div>
                    </div>

                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 185px;"><b>CECO :</b></span>
                            <select class="form-select" id="cost_center_stock" >
                                <option selected></option>
                                {% for ceco in list_cost_center%}
                                    <option>{{ ceco.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 185px;"><b>Albarà :</b></span>
                            <div class="flex-grow-1">
                                <input type="file" id="file_delivery_note" name="file_delivery_note" class="btn" style="border: 1px solid black; outline: none; width: 100%;">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 185px;"><b>Certificat d'anàlisi :</b></span>
                            <div class="flex-grow-1">
                                <input type="file" id="file_certificate" name="file_certificate" class="btn" style="border: 1px solid black; outline: none; width: 100%;">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 185px;"><b>Revisat per :</b></span>
                            <input type="text" class="form-control" id='revised_by' aria-label="TTN" aria-describedby="basic-addon1">
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 140px;"><b>Data revisat :</b></span>
                            <input type="text" class="form-control" id='date_revised' aria-label="TTN" aria-describedby="basic-addon1" oninput="replae_slash_with_hyphen(this); filter_characters(this)">
                        </div>
                    </div>

                    <center><button type="button" class="btn btn-primary btn-sm" onclick="add_stock_lot()">Afegir</button></center>
                </div>
                <input type="hidden" id="id_command" value="" />
                <input type="hidden" id="user_add_command" value="" />
            </div>
          </div>
        </div>
    </div>

    
    <div class="modal fade"  id="search_lot" tabindex="-1" role="dialog" aria-labelledby="editRegister" aria-hidden="true">
        <div class="modal-dialog modal-lg" tabindex="-1" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="title"> Cercar lots</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="close_modal('search_lot')"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <form action="/search_lots" method="post">
                    <div class="row">                                   
                        <div class="col-lg-12 col-md-12 col-sm-12">       
                            <div class="input-group mb-3">
                                <!-- <span class="input-group-text" id="basic-addon1"><b>Codi Cataleg, SAP o LOG :</b></span> -->
                                <span class="input-group-text" id="basic-addon1" style="width: 225px"><b>Codi Cataleg o Descripció :</b></span>
                                <input type="text" class="form-control" id='search_code' name="search_code" list="datalist-codes" aria-label="TTN" aria-describedby="basic-addon1" required>
                                <datalist id="datalist-codes">
                                    {% for description in list_desciption_lots %}
                                        <option value="{{description.description}}">{{description.catalog_reference}} - {{ description.description }}</option>
                                    {% endfor %}
                                </datalist>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="show_panel_input('div_panel_search')"><i class="fa-solid fa-plus"></i> panell</button>
                            </div>
                        </div>
                        <div class="col-lg-12 col-md-12 col-sm-12" style="display: none;" id="div_panel_search">       
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon1" style="width: 225px"><b>Codi panell (*):</b></span>
                                <input type="text" class="form-control" id='code_panel_search' name='code_panel_search' aria-label="TTN" aria-describedby="basic-addon1">
                            </div>
                        </div>    
                        <center><input type="submit" value="Cercar lot" class="btn btn-success btn-sm"/></center>
                    </div>
                </form>
            </div>
          </div>
        </div>
    </div>
    

    <div class="modal fade"  id="search_command" tabindex="-1" role="dialog" aria-labelledby="editRegister" aria-hidden="true">
        <div class="modal-dialog modal-lg" tabindex="-1" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="title">Comandes</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="close_modal('search_command')"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12">       
                        <div class="input-group mb-3">
                            <!-- <span class="input-group-text" id="basic-addon1"><b>Ref. proveïdor, SAP o LOG:</b></span> -->
                            <span class="input-group-text" id="basic-addon1" style="width: 235px;"><b>Ref. proveïdor o descripció:</b></span>
                            <input type="text" class="form-control" id='code_search_command' list="datalist-codes2" aria-label="TTN" aria-describedby="basic-addon1">
                            <datalist id="datalist-codes2">
                                {% for description in list_desciption_lots %}
                                    <option value="{{description.description}}">{{description.catalog_reference}} - {{ description.description }}</option>
                                {% endfor %}
                            </datalist>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="show_panel_input('div_panel_comand')"><i class="fa-solid fa-plus"></i> panell</button>
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12" style="display: none;" id="div_panel_comand">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 235px;"><b>Codi panell (*):</b></span>
                            <input type="text" class="form-control" id='code_panel_command' aria-label="TTN" aria-describedby="basic-addon1">
                        </div>
                    </div>
                    <center><button type="button" class="btn btn-primary btn-sm" onclick="info_add_comand(`{{session['acronim']}}`, `{{session['rol']}}`)">Accepta</button></center>
                </div>
            </div>
          </div>
        </div>
    </div>


    <div class="modal fade"  id="add_command" tabindex="-1" role="dialog" aria-labelledby="editRegister" aria-hidden="true">
        <div class="modal-dialog modal-lg" tabindex="-1" role="document">
          <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex justify-content-center w-100">
                    <h5 class="modal-title">Afegeix Comanda</h5>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="close_modal('add_command')"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div id="flash_message_comand"></div>
                    <div class="col-lg-6 col-md-12 col-sm-12">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 140px;"><b>Codi proveïdor:</b></span>
                            <input type="text" class="form-control" id="catalog_reference_command" aria-label="TTN" style="background-color: white;" readonly>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 135px;"><b>Codi SAP:</b></span>
                            <input type="text" class="form-control" id="code_sap_command" aria-label="TTN" style="background-color: white;" readonly>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 140px;"><b>Codi LOG:</b></span>
                            <input type="text" class="form-control" id="code_loc_command" aria-label="TTN" style="background-color: white;" readonly>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 140px;" name="span_units_command"><b>Unitats:</b></span>
                            <input type="number" class="form-control" id="units_command" aria-label="TTN" value="0">
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-12">       
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 140px;"><b>CECO :</b></span>
                            <select class="form-select" id="cost_center" onchange="show_hide_div_ceco(this.value)">
                                <option selected>--</option>
                                {% for ceco in list_cost_center%}
                                    <option>{{ ceco.name }}</option>
                                {% endfor %}
                                <option>Intoduïr manualment</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 col-sm-12" style="display: none;" id="div_ceco_manual">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 140px;"><b>CECO:</b></span>
                            <input type="text" class="form-control" id="cost_center_name" aria-label="TTN">
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 140px;"><b>Descripció:</b></span>
                            <input type="text" class="form-control" id="description_command" aria-label="TTN" style="background-color: white;" readonly>
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1" style="width: 140px;"><b>Observacions:</b></span>
                            <input type="text" class="form-control" id="observations_command" aria-label="TTN" style="background-color: white;">
                        </div>
                    </div>
                    <input type="hidden" id="key_lot_command" value=""/>
                    <center><button type="button" class="btn btn-primary btn-sm" onclick="add_command()">Afegir</button></center>
                </div>
            </div>
          </div>
        </div>
    </div>


    <div class="modal fade"  id="modal_search_fungible" tabindex="-1" role="dialog" aria-labelledby="editRegister" aria-hidden="true">
        <div class="modal-dialog modal-lg" tabindex="-1" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="title">Fungibles - Cerca fungibles -</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="close_modal('modal_search_fungible')"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <form action="/search_fungible" method="post">
                        <div class="col-lg-12 col-md-12 col-sm-12">       
                            <div class="input-group mb-3">
                                <!-- <span class="input-group-text" id="basic-addon1"><b>Ref. proveïdor, SAP o LOG:</b></span> -->
                                <span class="input-group-text" id="basic-addon1"><b>Ref. proveïdor, SAP o LOG :</b></span>
                                <input type="text" class="form-control" id='code_search_fungible' name='code_search_fungible' list="datalist-codes4" aria-label="TTN" aria-describedby="basic-addon1">
                                <datalist id="datalist-codes4">
                                    {% for description in list_desciption_lots %}
                                        {% if description.react_or_fungible == 'Fungible' %}
                                            <option value="{{description.description}}">{{description.catalog_reference}} - {{ description.description }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </datalist>
                            </div>
                        </div>
                        <center><button type="submit" class="btn btn-primary btn-sm" >Buscar</button></center>
                    </form>
                </div>
            </div>
          </div>
        </div>
    </div>


    <div class="modal fade"  id="open_close_lot" tabindex="-1" role="dialog" aria-labelledby="editRegister" aria-hidden="true">
        <div class="modal-dialog modal-lg" tabindex="-1" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="title"> Reactius - Obrir/tancar lots -</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="close_modal('open_lot')"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <form action="/search_lots_open_close" method="post">
                    <div class="row">                                   
                        <div class="col-lg-12 col-md-12 col-sm-12">       
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon1"><b>Ref. proveïdor, Subref. o Descripció :</b></span>
                                <input type="text" class="form-control" id='reference' name="reference" list="datalist-codes3" aria-label="TTN" aria-describedby="basic-addon1" required>
                                <datalist id="datalist-codes3">
                                    {% for description in list_desciption_lots %}
                                        {% if description.react_or_fungible == 'Reactiu' %}
                                            {% if description.description_subreference == '' %}
                                                <option value="{{description.description}}">{{description.catalog_reference}} - {{ description.description }}</option>
                                            {% else %}
                                                <option value="{{description.description_subreference}}">{{description.id_reactive}} - {{ description.description_subreference }}</option>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </datalist>
                            </div>
                        </div> 
                        <center><input type="submit" value="Cercar lot" class="btn btn-success btn-sm"/></center>
                    </div>
                </form>
            </div>
          </div>
        </div>
    </div>


    <div class="modal fade"  id="open_update_price" tabindex="-1" role="dialog" aria-labelledby="editRegister" aria-hidden="true">
        <div class="modal-dialog modal-md" tabindex="-1" role="document">
          <div class="modal-content">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <h5 class="modal-title" id="title"> Actualitzar Preus</h5>
                <div>
                    <button type="button" class="btn btn-link" id='_delivery_note' onclick="download_template()"><i class="fa-solid fa-file-arrow-down"></i> Plantilla</button>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="close_modal('open_update_price')"><span aria-hidden="true">&times;</span></button>
                </div>
            </div>      
            <div class="modal-body">
                <div class="row">                                   
                    <div class="col-lg-12 col-md-12 col-sm-12">       
                        <div class="mb-3">
                            <label for="formFile" class="form-label"><i>Carrega plantilla amb els canvis de preu</i></label>
                            <div class="d-flex align-items-center">
                                <input class="form-control me-2" type="file" id="file" name="file" style="flex: 1;">
                                <button type="button" class="btn btn-primary" onclick="charge_doc_price()" style="margin-left: -10px;"><i class="fa-sharp fa-solid fa-file-arrow-up"></i> Carregar</button>
                            </div>
                        </div>                            
                    </div> 
                </div>
            </div>
          </div>
        </div>
        <form action="/download_template_price" method="post" id="down_excel">
        </form>
    </div>


    <div class="modal fade modal-custom95"  id="modal_order_tracking_no_admin" tabindex="-1" role="dialog" aria-labelledby="editRegister" aria-hidden="true">
        <div class="modal-dialog modal-xl" tabindex="-1" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="title"> Seguiment Comandes</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="close_modal('modal_order_tracking_no_admin')"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row">                                   
                    <div class="col-lg-12 col-md-12 col-sm-12">       
                        <table id="table_order_tracking_no_admin" class="display" style="width: 100%;">
                            <thead>
                                <tr id="thcolor">
                                    <th style="width: 100px;">Ref. Proveïdor</th>
                                    <th style="width: 350px;">Descripció</th>
                                    <!-- <th style="width: 100px;" name="th_subreference">Id Suref.</th>
                                    <th style="width: 350px;" name="th_subreference">Descripció Subref.</th> -->
                                    <th style="width: 80px;">Codi Comanda</th>
                                    <th style="width: 80px;">Codi SAP</th>
                                    <th style="width: 80px;">Codi LOG</th>
                                    <th style="width: 80px;">Unitats</th>
                                    <!-- <th style="width: 80px;">Data creació</th>
                                    <th style="width: 80px;">Usuari</th> -->
                                    <th style="width: 80px;">Data Tramitació</th>
                                    <th style="width: 80px;">Usuari</th>
                                    <th style="width: 80px;">CECO</th>
                                    <th style="width: 80px;">Observacions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div> 
                </div>
            </div>
          </div>
        </div>
    </div>
    <script src="/static/js/bootstrap.js"></script>
</body>                    
</html>